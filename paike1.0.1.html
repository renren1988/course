<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>排课系统</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .nav {
            margin-bottom: 20px;
        }

        .nav a {
            text-decoration: none;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            margin-right: 10px;
        }

        .initial-setup {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
        }

        .schedule-form {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
        }

        .schedule-table th,
        .schedule-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            vertical-align: top;
            /* 让内容从顶部开始显示 */
        }

        .schedule-table th {
            background-color: #f2f2f2;
        }

        .week-nav {
            text-align: center;
            margin: 20px 0;
        }

        select,
        input {
            padding: 5px;
            margin: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        button {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        .class-block {
            background-color: #e3f2fd;
            padding: 5px;
            margin: 2px;
            border-radius: 3px;
            white-space: pre-line;
            /* 保留换行符 */
        }

        /* 美化教师选择框样式 */
        .teacher-select-container {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .teacher-select-container label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: bold;
        }

        .teacher-list {
            width: 100%;
            min-height: 120px;
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 8px;
            background: white;
        }

        .teacher-item {
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-block;
            margin-right: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
        }

        .teacher-item:hover {
            background-color: #e9ecef;
        }

        .teacher-item.selected {
            background-color: #4CAF50;
            color: white;
        }

        /* 添加提示文本 */
        .select-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>

<body>
    <div class="nav">
        <a href="#" onclick="showScheduling()">排课</a>
        <a href="#" onclick="showViewSchedule()">查看课表</a>
    </div>

    <div id="initialSetup" class="initial-setup">
        <h2>初始设置</h2>
        <div>
            <label>教师数量：</label>
            <input type="number" id="teacherCount" min="1">
        </div>
        <div>
            <label>学生组数：</label>
            <input type="number" id="groupCount" min="1">
        </div>
        <button onclick="saveInitialSetup()">确认</button>
    </div>

    <div id="schedulingPage">
        <div class="schedule-form">
            <div class="teacher-select-container">
                <label>选择授课教师：</label>
                <div id="teacherList" class="teacher-list">
                </div>
                <div class="select-hint">点击选择或取消选择教师</div>
            </div>
            <select id="groupSelect">
                <option value="">选择学生组</option>
            </select>
            <select id="daySelect">
                <option value="">选择星期</option>
                <option value="1">星期一</option>
                <option value="2">星期二</option>
                <option value="3">星期三</option>
                <option value="4">星期四</option>
                <option value="5">星期五</option>
                <option value="6">星期六</option>
                <option value="7">星期日</option>
            </select>
            <select id="timeSelect">
                <option value="">选择时间段</option>
                <option value="1">第一节 (8:00-9:35)</option>
                <option value="2">第二节 (10:00-11:35)</option>
                <option value="3">第三节 (13:30-15:05)</option>
                <option value="4">第四节 (15:30-17:05)</option>
                <option value="5">第五节 (18:00-19:35)</option>
            </select>
            <input type="text" id="location" placeholder="上课地点">
            <input type="text" id="className" placeholder="课程名称">
            <button onclick="addSchedule()">添加课程</button>
        </div>

        <div class="week-nav">
            <button onclick="previousWeek()">上一周</button>
            <span id="currentWeek"></span>
            <button onclick="nextWeek()">下一周</button>
        </div>

        <table class="schedule-table">
            <thead>
                <tr>
                    <th>时间/日期</th>
                    <th>星期一</th>
                    <th>星期二</th>
                    <th>星期三</th>
                    <th>星期四</th>
                    <th>星期五</th>
                    <th>星期六</th>
                    <th>星期日</th>
                </tr>
            </thead>
            <tbody id="scheduleBody">
                <tr>
                    <td>第一节 (8:00-9:35)</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>第二节 (10:00-11:35)</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>第三节 (13:30-15:05)</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>第四节 (15:30-17:05)</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>第五节 (18:00-19:35)</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        // 存储教师、学生组和课程安排的数组/对象
        let teachers = [];
        let groups = [];
        let schedule = {};
        let currentDate = new Date();
        let selectedTeachers = new Set();

        // 页面加载时检查是否首次使用
        window.onload = function () {
            // 初始化 schedule
            schedule = JSON.parse(localStorage.getItem('schedule') || '{}');

            if (!localStorage.getItem('initialized')) {
                document.getElementById('initialSetup').style.display = 'block';
            } else {
                loadData();
                updateScheduleTable();
            }
        }

        // 保存初始设置
        function saveInitialSetup() {
            const teacherCount = document.getElementById('teacherCount').value;
            const groupCount = document.getElementById('groupCount').value;

            // 根据输入的数量生成教师和学生组数组
            teachers = Array.from({ length: teacherCount }, (_, i) => `教师${i + 1}`);
            groups = Array.from({ length: groupCount }, (_, i) => `组${i + 1}`);

            // 将数据保存到localStorage
            localStorage.setItem('teachers', JSON.stringify(teachers));
            localStorage.setItem('groups', JSON.stringify(groups));
            localStorage.setItem('initialized', 'true');

            document.getElementById('initialSetup').style.display = 'none';
            loadData();
        }

        // 从localStorage加载数据并更新选择框
        function loadData() {
            teachers = JSON.parse(localStorage.getItem('teachers') || '[]');
            groups = JSON.parse(localStorage.getItem('groups') || '[]');
            schedule = JSON.parse(localStorage.getItem('schedule') || '{}');

            const teacherList = document.getElementById('teacherList');
            const groupSelect = document.getElementById('groupSelect');

            // 重置选择框
            teacherList.innerHTML = '';
            groupSelect.innerHTML = '<option value="">选择学生组</option>';

            // 添加教师选项
            teachers.forEach(teacher => {
                const div = document.createElement('div');
                div.className = 'teacher-item';
                div.textContent = teacher;
                div.onclick = () => toggleTeacher(teacher, div);
                teacherList.appendChild(div);
            });

            // 添加学生组选项
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                groupSelect.appendChild(option);
            });
        }

        // 切换教师选择状态
        function toggleTeacher(teacher, element) {
            if (selectedTeachers.has(teacher)) {
                selectedTeachers.delete(teacher);
                element.classList.remove('selected');
            } else {
                selectedTeachers.add(teacher);
                element.classList.add('selected');
            }
        }

        // 检查课程安排是否合理
        function checkSchedule(date, time, teachers, group) {
            // 获取当天该组的课程数量
            let groupClassCount = 0;
            Object.keys(schedule).forEach(key => {
                if (key.startsWith(date)) {
                    schedule[key].forEach(cls => {
                        if (cls.group === group) {
                            groupClassCount++;
                        }
                    });
                }
            });

            // 检查当天该时间段是否已有该教师或该组的课程
            const key = `${date}-${time}`;
            if (schedule[key]) {
                for (let cls of schedule[key]) {
                    // 检查是否有教师时间冲突
                    for (let teacher of teachers) {
                        if (cls.teachers.includes(teacher)) {
                            return { valid: false, message: "所选教师中有教师在此时间段已有课程安排" };
                        }
                    }
                    if (cls.group === group) {
                        return { valid: false, message: "该学生组在此时间段已有课程安排" };
                    }
                }
            }

            // 检查该组当天的课程数量是否已达到2节
            if (groupClassCount >= 2) {
                return { valid: false, message: "该学生组当天课程已达到四学时" };
            }

            return { valid: true };
        }

        // 添加新的课程安排
        function addSchedule() {
            // 添加调试日志
            console.log('添加课程按钮被点击');

            const selectedTeachersArray = Array.from(selectedTeachers);

            console.log('选中的教师:', selectedTeachersArray);

            const group = document.getElementById('groupSelect').value;
            const day = document.getElementById('daySelect').value;
            const time = document.getElementById('timeSelect').value;
            const location = document.getElementById('location').value;
            const className = document.getElementById('className').value;

            console.log('表单数据:', {
                group,
                day,
                time,
                location,
                className
            });

            // 验证所有字段都已填写
            if (selectedTeachersArray.length === 0 || !group || !day || !time || !location || !className) {
                alert('请填写所有信息');
                return;
            }

            // 根据选择的星期几调整日期
            const targetDate = new Date(currentDate);
            const currentDay = targetDate.getDay() || 7;
            const diff = parseInt(day) - currentDay;
            targetDate.setDate(targetDate.getDate() + diff);

            // 生成课程安排的键值
            const date = getFormattedDate(targetDate);

            // 检查课程安排是否合理
            const checkResult = checkSchedule(date, time, selectedTeachersArray, group);
            if (!checkResult.valid) {
                alert(checkResult.message);
                return;
            }

            const key = `${date}-${time}`;

            // 如果该时间段没有安排，创建新数组
            if (!schedule[key]) {
                schedule[key] = [];
            }

            // 添加新的课程安排
            schedule[key].push({
                teachers: selectedTeachersArray,
                group,
                location,
                className
            });

            // 保存到localStorage并更新显示
            localStorage.setItem('schedule', JSON.stringify(schedule));

            // 清空输入框和选择
            document.getElementById('location').value = '';
            document.getElementById('className').value = '';
            document.getElementById('groupSelect').value = '';
            document.getElementById('daySelect').value = '';
            document.getElementById('timeSelect').value = '';
            selectedTeachers.clear();
            document.querySelectorAll('.teacher-item').forEach(item => {
                item.classList.remove('selected');
            });

            updateScheduleTable();
        }

        // 更新课程表显示
        function updateScheduleTable() {
            const tbody = document.getElementById('scheduleBody');
            const rows = tbody.getElementsByTagName('tr');

            // 清空所有单元格内容（除了第一列的时间）
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                for (let j = 1; j < cells.length; j++) {
                    cells[j].innerHTML = '';
                }
            }

            // 获取当前周的起始日期
            const weekStart = new Date(currentDate);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);

            // 遍历每一天
            for (let day = 0; day < 7; day++) {
                const currentDay = new Date(weekStart);
                currentDay.setDate(currentDay.getDate() + day);
                const dateStr = getFormattedDate(currentDay);

                // 遍历每个时间段
                for (let timeSlot = 1; timeSlot <= 5; timeSlot++) {
                    const key = `${dateStr}-${timeSlot}`;
                    if (schedule[key]) {
                        const cell = rows[timeSlot - 1].cells[day + 1];
                        schedule[key].forEach(cls => {
                            const div = document.createElement('div');
                            div.className = 'class-block';
                            // 添加空值检查
                            const teacherText = cls.teachers && Array.isArray(cls.teachers) ? cls.teachers.join('、') : '';
                            div.textContent = `${cls.className || ''}\n${teacherText}\n${cls.group || ''}\n${cls.location || ''}`;
                            cell.appendChild(div);
                        });
                    }
                }
            }

            updateWeekDisplay();
        }

        // 格式化日期为YYYY-MM-DD格式
        function getFormattedDate(date) {
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
        }

        // 显示上一周的课程表
        function previousWeek() {
            currentDate.setDate(currentDate.getDate() - 7);
            updateScheduleTable();
        }

        // 显示下一周的课程表
        function nextWeek() {
            currentDate.setDate(currentDate.getDate() + 7);
            updateScheduleTable();
        }

        // 更新当前显示的周期范围
        function updateWeekDisplay() {
            const startDate = new Date(currentDate);
            startDate.setDate(startDate.getDate() - startDate.getDay() + 1);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 6);

            document.getElementById('currentWeek').textContent =
                `${getFormattedDate(startDate)} 至 ${getFormattedDate(endDate)}`;
        }

        // 显示排课页面
        function showScheduling() {
            document.getElementById('schedulingPage').style.display = 'block';
        }

        // 显示查看课表页面（待开发）
        function showViewSchedule() {
            alert('功能开发中');
        }
    </script>
</body>

</html>