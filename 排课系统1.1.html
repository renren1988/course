<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>排课系统</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .nav {
            margin-bottom: 20px;
        }
        .nav a {
            text-decoration: none;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            margin-right: 10px;
        }
        .initial-setup {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
        }
        .schedule-form {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .schedule-table th {
            background-color: #f2f2f2;
        }
        .week-nav {
            text-align: center;
            margin: 20px 0;
        }
        select, input {
            padding: 5px;
            margin: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        button {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .class-block {
            background-color: #e3f2fd;
            padding: 5px;
            margin: 2px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="nav">
        <a href="#" onclick="showScheduling()">排课</a>
        <a href="#" onclick="showViewSchedule()">查看课表</a>
    </div>

    <div id="initialSetup" class="initial-setup">
        <h2>初始设置</h2>
        <div>
            <label>教师数量：</label>
            <input type="number" id="teacherCount" min="1">
        </div>
        <div>
            <label>学生组数：</label>
            <input type="number" id="groupCount" min="1">
        </div>
        <button onclick="saveInitialSetup()">确认</button>
    </div>

    <div id="schedulingPage">
        <div class="schedule-form">
            <div class="teacher-select-container">
                <option value="">选择教师(可多选):</option>
                <select id="teacherSelect" multiple size="4" style="width: 200px;">
                </select>
            </div>
            <select id="groupSelect">
                <option value="">选择学生组</option>
            </select>
            <select id="timeSelect">
                <option value="">选择时间段</option>
                <option value="1">第一节 (8:00-9:35)</option>
                <option value="2">第二节 (10:00-11:35)</option>
                <option value="3">第三节 (13:30-15:05)</option>
                <option value="4">第四节 (15:30-17:05)</option>
                <option value="5">第五节 (18:00-19:35)</option>
            </select>
            <input type="text" id="location" placeholder="上课地点">
            <input type="text" id="className" placeholder="课程名称">
            <button onclick="addSchedule()">添加课程</button>
        </div>

        <div class="week-nav">
            <button onclick="previousWeek()">上一周</button>
            <span id="currentWeek"></span>
            <button onclick="nextWeek()">下一周</button>
        </div>

        <table class="schedule-table">
            <thead>
                <tr>
                    <th>时间/日期</th>
                    <th>星期一</th>
                    <th>星期二</th>
                    <th>星期三</th>
                    <th>星期四</th>
                    <th>星期五</th>
                    <th>星期六</th>
                    <th>星期日</th>
                </tr>
            </thead>
            <tbody id="scheduleBody">
            </tbody>
        </table>
    </div>

    <script>
        let teachers = [];
        let groups = [];
        let schedule = {};
        let currentDate = new Date();

        // 检查是否是首次使用
        window.onload = function() {
            if (!localStorage.getItem('initialized')) {
                document.getElementById('initialSetup').style.display = 'block';
            } else {
                loadData();
                updateScheduleTable();
            }
        }

        function saveInitialSetup() {
            const teacherCount = document.getElementById('teacherCount').value;
            const groupCount = document.getElementById('groupCount').value;
            
            teachers = Array.from({length: teacherCount}, (_, i) => `教师${i + 1}`);
            groups = Array.from({length: groupCount}, (_, i) => `组${i + 1}`);
            
            localStorage.setItem('teachers', JSON.stringify(teachers));
            localStorage.setItem('groups', JSON.stringify(groups));
            localStorage.setItem('initialized', 'true');
            
            document.getElementById('initialSetup').style.display = 'none';
            loadData();
        }

        function loadData() {
            teachers = JSON.parse(localStorage.getItem('teachers') || '[]');
            groups = JSON.parse(localStorage.getItem('groups') || '[]');
            schedule = JSON.parse(localStorage.getItem('schedule') || '{}');
            
            const teacherSelect = document.getElementById('teacherSelect');
            const groupSelect = document.getElementById('groupSelect');
            
            teacherSelect.innerHTML = '<option value="">选择教师</option>';
            groupSelect.innerHTML = '<option value="">选择学生组</option>';
            
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher;
                option.textContent = teacher;
                teacherSelect.appendChild(option);
            });
            
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                groupSelect.appendChild(option);
            });
        }

        function addSchedule() {
            const teacher = document.getElementById('teacherSelect').value;
            const group = document.getElementById('groupSelect').value;
            const time = document.getElementById('timeSelect').value;
            const location = document.getElementById('location').value;
            const className = document.getElementById('className').value;
            
            if (!teacher || !group || !time || !location || !className) {
                alert('请填写所有信息');
                return;
            }
            
            const date = getFormattedDate(currentDate);
            const key = `${date}-${time}`;
            
            if (!schedule[key]) {
                schedule[key] = [];
            }
            
            schedule[key].push({
                teacher,
                group,
                location,
                className
            });
            
            localStorage.setItem('schedule', JSON.stringify(schedule));
            updateScheduleTable();
        }

        function updateScheduleTable() {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            
            const times = ['8:00-9:35', '10:00-11:35', '13:30-15:05', '15:30-17:05', '18:00-19:35'];
            
            times.forEach((time, index) => {
                const row = document.createElement('tr');
                const timeCell = document.createElement('td');
                timeCell.textContent = time;
                row.appendChild(timeCell);
                
                for (let i = 0; i < 7; i++) {
                    const cell = document.createElement('td');
                    const date = new Date(currentDate);
                    date.setDate(date.getDate() - date.getDay() + i + 1);
                    const dateStr = getFormattedDate(date);
                    const key = `${dateStr}-${index + 1}`;
                    
                    if (schedule[key]) {
                        schedule[key].forEach(cls => {
                            const div = document.createElement('div');
                            div.className = 'class-block';
                            div.textContent = `${cls.className}\n${cls.teacher}\n${cls.group}\n${cls.location}`;
                            cell.appendChild(div);
                        });
                    }
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
            });
            
            updateWeekDisplay();
        }

        function getFormattedDate(date) {
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
        }

        function previousWeek() {
            currentDate.setDate(currentDate.getDate() - 7);
            updateScheduleTable();
        }

        function nextWeek() {
            currentDate.setDate(currentDate.getDate() + 7);
            updateScheduleTable();
        }

        function updateWeekDisplay() {
            const startDate = new Date(currentDate);
            startDate.setDate(startDate.getDate() - startDate.getDay() + 1);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 6);
            
            document.getElementById('currentWeek').textContent = 
                `${getFormattedDate(startDate)} 至 ${getFormattedDate(endDate)}`;
        }

        window.onbeforeunload = function() {
            // 检查每个小组每天的排课数量
            const dateSchedules = {};
            Object.keys(schedule).forEach(key => {
                const [date] = key.split('-');
                if (!dateSchedules[date]) {
                    dateSchedules[date] = {
                        groups: {},
                        teachers: {}
                    };
                }
                
                schedule[key].forEach(cls => {
                    if (!dateSchedules[date].groups[cls.group]) {
                        dateSchedules[date].groups[cls.group] = 0;
                    }
                    dateSchedules[date].groups[cls.group]++;
                    
                    if (!dateSchedules[date].teachers[cls.teacher]) {
                        dateSchedules[date].teachers[cls.teacher] = 0;
                    }
                    dateSchedules[date].teachers[cls.teacher]++;
                });
            });
            
            let warnings = [];
            
            Object.keys(dateSchedules).forEach(date => {
                Object.keys(dateSchedules[date].groups).forEach(group => {
                    if (dateSchedules[date].groups[group] < 2) {
                        warnings.push(`${date} ${group}的课程数量少于2节`);
                    }
                });
                
                teachers.forEach(teacher => {
                    if (!dateSchedules[date].teachers[teacher]) {
                        warnings.push(`${date} ${teacher}没有被排课`);
                    }
                });
            });
            
            if (warnings.length > 0) {
                return warnings.join('\n');
            }
        }

        function showScheduling() {
            document.getElementById('schedulingPage').style.display = 'block';
        }

        function showViewSchedule() {
            // 可以添加查看课表的专门页面
            alert('功能开发中');
        }
    </script>
</body>
</html>
